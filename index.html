<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>3D Ombor — To'liq Interaktiv (Variant B)</title>
  <style>
    html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif;background:#111;color:#fff}
    #topbar{position:fixed;left:0;right:0;top:0;height:44px;background:#111;display:flex;align-items:center;padding:6px 10px;z-index:20;gap:8px;box-shadow:0 2px 8px rgba(0,0,0,0.4)}
    #search{padding:6px 8px;font-size:14px;width:320px}
    #focusBtn{padding:6px 10px}
    #container{position:absolute;left:0;right:0;top:44px;bottom:0;overflow:hidden}
    .tooltip{position:fixed;display:none;z-index:30;background:#fff;color:#000;padding:8px;border-radius:6px;box-shadow:0 6px 18px rgba(0,0,0,0.25);font-size:13px}
    #legend{position:fixed;left:12px;top:56px;background:rgba(255,255,255,0.95);padding:8px;border-radius:6px;color:#000;font-size:13px;z-index:25}
    button{cursor:pointer}
  </style>
</head>
<body>
  <div id="topbar">
    <strong style="margin-right:8px">3D Ombor — To'liq Interaktiv</strong>
    <input id="search" placeholder="Qidirish: nom yoki ID (masalan: R1-1-1)" />
    <button id="focusBtn">Topib ko'rsat</button>
    <span style="margin-left:12px;color:#bbb;font-size:13px">(8 stellaj, 192 hujayra — demo)</span>
  </div>

  <div id="container"></div>
  <div id="legend">Click a cell to see details</div>
  <div id="tooltip" class="tooltip"></div>

  <!-- Three.js (HTTPS) -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.154.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.154.0/examples/js/controls/OrbitControls.js"></script>

  <script>
  // -------- CONFIG ----------
  const IMAGE_URL = '/mnt/data/7f1be33a-4cff-4e33-9831-d17036061f51.jpg'; // provided image path (will be transformed on hosting)
  const RACK_COUNT = 8;
  const ROWS_PER_RACK = 6;
  const COLS_PER_RACK = 4;
  const CELL_W = 1.0, CELL_H = 0.28, CELL_D = 0.6;

  // --------- Scene ----------
  const container = document.getElementById('container');
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0xdddddd);

  const camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 1000);
  camera.position.set(8, 5, 14);

  const renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setPixelRatio(window.devicePixelRatio ? window.devicePixelRatio : 1);
  renderer.setSize(window.innerWidth, window.innerHeight - 44);
  container.appendChild(renderer.domElement);

  const controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.target.set(0,1,0);
  controls.update();

  // lights
  const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 0.9); scene.add(hemi);
  const dir = new THREE.DirectionalLight(0xffffff, 0.8); dir.position.set(5,10,7); scene.add(dir);

  // ground
  const ground = new THREE.Mesh(new THREE.PlaneGeometry(60,60), new THREE.MeshStandardMaterial({color:0xf2f2f2}));
  ground.rotation.x = -Math.PI/2; ground.position.y = -0.01; scene.add(ground);

  // backdrop wall from user's image
  const loader = new THREE.TextureLoader();
  loader.setCrossOrigin('anonymous');
  loader.load(IMAGE_URL, tex=>{
    const wall = new THREE.Mesh(new THREE.PlaneGeometry(30,10), new THREE.MeshBasicMaterial({map:tex}));
    wall.position.set((RACK_COUNT-1)*1.1/2, 4.5, -6);
    scene.add(wall);
  }, undefined, err=>{
    console.warn('Background image not loaded, continuing without it.', err);
  });

  // racks and cells
  const racks = [];
  const cellObjects = [];
  const baseMaterial = new THREE.MeshStandardMaterial({metalness:0.2,roughness:0.6,color:0x9fb7c8});

  let idCounter = 1;
  for(let r=0; r<RACK_COUNT; r++){
    const rack = new THREE.Group();
    const rackX = (r - (RACK_COUNT-1)/2) * (COLS_PER_RACK * (CELL_W + 0.12) + 0.6);
    rack.position.set(rackX, 0, 0);

    // frame
    const frame = new THREE.Mesh(new THREE.BoxGeometry(COLS_PER_RACK*CELL_W + 0.5, ROWS_PER_RACK*(CELL_H+0.02)+0.5, CELL_D+0.5),
                                new THREE.MeshStandardMaterial({color:0x222222}));
    frame.position.set(0, ROWS_PER_RACK*(CELL_H+0.02)/2 - 0.05, 0);
    rack.add(frame);

    // create cells
    for(let row=0; row<ROWS_PER_RACK; row++){
      for(let col=0; col<COLS_PER_RACK; col++){
        const box = new THREE.Mesh(new THREE.BoxGeometry(CELL_W, CELL_H, CELL_D), baseMaterial.clone());
        const x = (col - (COLS_PER_RACK-1)/2) * (CELL_W + 0.12);
        const y = row*(CELL_H+0.02) + CELL_H/2 + 0.05;
        box.position.set(x, y, 0);
        box.userData = {
          id: `R${r+1}-${row+1}-${col+1}`,
          name: `Material ${idCounter}`,
          qty: Math.floor(Math.random()*500)+1,
          rack: r+1, row: row+1, col: col+1
        };
        idCounter++;
        rack.add(box);
        cellObjects.push(box);
      }
    }

    scene.add(rack);
    racks.push(rack);
  }

  // outline/highlight material
  const highlightColor = new THREE.Color(0xffd54f);

  // tooltip handling
  const tooltip = document.getElementById('tooltip');

  const raycaster = new THREE.Raycaster();
  const pointer = new THREE.Vector2();

  function onPointerDown(e){
    const rect = renderer.domElement.getBoundingClientRect();
    pointer.x = ((e.clientX - rect.left)/rect.width)*2 -1;
    pointer.y = -((e.clientY - rect.top)/rect.height)*2 +1;
    raycaster.setFromCamera(pointer, camera);
    const hits = raycaster.intersectObjects(cellObjects, false);
    if(hits.length>0){
      const obj = hits[0].object;
      showTooltip(obj, e.clientX, e.clientY);
      highlight(obj);
    } else {
      tooltip.style.display = 'none';
      removeHighlights();
    }
  }
  renderer.domElement.addEventListener('pointerdown', onPointerDown);

  function showTooltip(obj, clientX, clientY){
    const d = obj.userData;
    tooltip.style.left = (clientX + 12) + 'px';
    tooltip.style.top = (clientY + 12) + 'px';
    tooltip.style.display = 'block';
    tooltip.innerHTML = `<strong>${d.name}</strong><br>ID: ${d.id}<br>Miqdor: ${d.qty}<br>Stellaj: ${d.rack} Qavat: ${d.row} Bo'lim: ${d.col}`;
  }

  function highlight(obj){
    removeHighlights();
    obj.material = obj.material.clone();
    obj.material.emissive = highlightColor;
    obj.material.emissiveIntensity = 0.6;
  }

  function removeHighlights(){
    cellObjects.forEach(c => {
      if(c.material && c.material.emissive){ c.material.emissiveIntensity = 0; }
    });
  }

  // search
  const searchInput = document.getElementById('search');
  const focusBtn = document.getElementById('focusBtn');

  function findByText(q){
    q = q.trim().toLowerCase();
    if(!q) return [];
    return cellObjects.filter(c=>{
      return c.userData.id.toLowerCase().includes(q) || c.userData.name.toLowerCase().includes(q);
    });
  }

  focusBtn.addEventListener('click', ()=>{
    const q = searchInput.value;
    const matches = findByText(q);
    if(matches.length===0){ alert('Topilmadi'); return; }
    const t = matches[0];
    const wp = new THREE.Vector3(); t.getWorldPosition(wp);
    controls.target.copy(wp);
    camera.position.set(wp.x + 2.2, wp.y + 1.6, wp.z + 3.6);
    controls.update();
    showTooltip(t, window.innerWidth/2, window.innerHeight/2);
    highlight(t);
  });

  // responsive
  window.addEventListener('resize', ()=>{
    renderer.setSize(window.innerWidth, window.innerHeight - 44);
    camera.aspect = window.innerWidth / (window.innerHeight - 44);
    camera.updateProjectionMatrix();
  });

  // animate
  function animate(){
    requestAnimationFrame(animate);
    renderer.render(scene, camera);
  }
  animate();

  // helper: export data mapping (example)
  function exportInventory(){
    return cellObjects.map(c=>c.userData);
  }
  // expose for debugging
  window.__WAREHOUSE = { cells: cellObjects, exportInventory };

  </script>
</body>
</html>
