<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>3D Ombor — Interaktiv Stellaj</title>
  <style>
    html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif}
    #app{height:100%;display:flex;flex-direction:column}
    #topbar{padding:8px;background:#111;color:#fff;display:flex;align-items:center;gap:8px}
    #search{padding:6px 8px;font-size:14px;min-width:260px}
    #container{flex:1;position:relative}
    canvas{display:block}
    .tooltip{position:absolute;min-width:160px;padding:8px;background:#fff;border:1px solid #ccc;border-radius:6px;box-shadow:0 6px 18px rgba(0,0,0,0.2);display:none;z-index:10}
    button{padding:6px 10px}
  </style>
</head>
<body>
<div id="app">
  <div id="topbar">
    <strong>3D Ombor — Interaktiv Stellaj</strong>
    <input id="search" placeholder="Qidirish: nom yoki ID yozing (masalan: R1-C3)" />
    <button id="focusBtn">Topib ko'rsat</button>
    <span style="margin-left:8px;color:#ddd;font-size:13px">(Misol: 8 ta stellaj, 192 hujayra, 32500 materialni yuklash mumkin)</span>
  </div>
  <div id="container"></div>
</div>

<!-- Three.js -->
<script src="https://cdn.jsdelivr.net/npm/three@0.154.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.154.0/examples/js/controls/OrbitControls.js"></script>

<script>
// -------- CONFIG --------
const IMAGE_URL = '7f1be33a-4cff-4e33-9831-d17036061f51.jpg'; // image must be in same folder as this HTML when hosting
const RACK_COUNT = 8;
const ROWS_PER_RACK = 6;
const COLS_PER_RACK = 4;
const CELL_W = 1.0, CELL_H = 0.25, CELL_D = 0.5;

// -------- SCENE SETUP --------
const container = document.getElementById('container');
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(45, container.clientWidth/container.clientHeight, 0.1, 1000);
camera.position.set(6,4,10);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(container.clientWidth || window.innerWidth, container.clientHeight || window.innerHeight);
container.appendChild(renderer.domElement);

const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.target.set(3,1,0);
controls.update();

const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 1.0); scene.add(hemi);
const dir = new THREE.DirectionalLight(0xffffff, 0.6); dir.position.set(5,10,7); scene.add(dir);

const ground = new THREE.Mesh(new THREE.PlaneGeometry(50,50), new THREE.MeshBasicMaterial({color:0xf0f0f0}));
ground.rotation.x = -Math.PI/2; ground.position.y = -0.01; scene.add(ground);

const racks = [];
const cellObjects = [];
const boxMaterial = new THREE.MeshLambertMaterial({color:0x8aa4bd});

// load texture (wall/backdrop) from same folder
const loader = new THREE.TextureLoader();
loader.load(IMAGE_URL, texture => {
  const wall = new THREE.Mesh(new THREE.PlaneGeometry(20,6), new THREE.MeshBasicMaterial({map:texture}));
  wall.position.set(3,2.5,-6);
  scene.add(wall);
}, undefined, err => {
  // ignore errors if image not present
  console.warn('Background image failed to load:', err);
});

// build racks
let idCounter = 1;
for(let r=0;r<RACK_COUNT;r++){
  const rackGroup = new THREE.Group();
  rackGroup.name = `Rack-${r+1}`;
  rackGroup.position.set(r*2.2 - (RACK_COUNT*2.2)/2 + 1.1, 0, 0);

  const frameGeo = new THREE.BoxGeometry(COLS_PER_RACK*CELL_W + 0.4, ROWS_PER_RACK*(CELL_H+0.02)+0.4, CELL_D+0.4);
  const frame = new THREE.Mesh(frameGeo, new THREE.MeshLambertMaterial({color:0x222222, transparent:true, opacity:0.85}));
  frame.position.set(0, ROWS_PER_RACK*(CELL_H+0.02)/2 - 0.05, 0);
  rackGroup.add(frame);

  for(let row=0; row<ROWS_PER_RACK; row++){
    for(let col=0; col<COLS_PER_RACK; col++){
      const boxGeo = new THREE.BoxGeometry(CELL_W, CELL_H, CELL_D);
      const mesh = new THREE.Mesh(boxGeo, boxMaterial.clone());
      const x = (col - (COLS_PER_RACK-1)/2) * (CELL_W + 0.12);
      const y = row*(CELL_H+0.02) + CELL_H/2;
      mesh.position.set(x, y, 0);
      mesh.userData = {
        id: `R${r+1}-C${row+1}-${col+1}`,
        name: `Material ${idCounter}`,
        quantity: Math.floor(Math.random()*100)+1,
        rack: r+1, row: row+1, col: col+1
      };
      idCounter++;
      rackGroup.add(mesh);
      cellObjects.push(mesh);
    }
  }
  scene.add(rackGroup);
  racks.push(rackGroup);
}

// tooltip
const tooltip = document.createElement('div');
tooltip.className = 'tooltip';
tooltip.style.position = 'absolute';
tooltip.style.display = 'none';
document.body.appendChild(tooltip);

// raycasting
const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();

function onPointerDown(event){
  const rect = renderer.domElement.getBoundingClientRect();
  mouse.x = ((event.clientX - rect.left)/rect.width)*2 -1;
  mouse.y = -((event.clientY - rect.top)/rect.height)*2 +1;
  raycaster.setFromCamera(mouse, camera);
  const intersects = raycaster.intersectObjects(cellObjects, true);
  if(intersects.length>0){
    const obj = intersects[0].object;
    const d = obj.userData;
    tooltip.style.left = (event.clientX + 12) + 'px';
    tooltip.style.top = (event.clientY + 12) + 'px';
    tooltip.style.display = 'block';
    tooltip.innerHTML = `<strong>${d.name}</strong><br>ID: ${d.id}<br>Jami: ${d.quantity}<br>Stellaj: ${d.rack} Qavat: ${d.row} Bo'lim: ${d.col}`;
  } else {
    tooltip.style.display = 'none';
  }
}
renderer.domElement.addEventListener('pointerdown', onPointerDown);

// search
const searchInput = document.getElementById('search');
const focusBtn = document.getElementById('focusBtn');

function findByText(q){
  q = q.trim().toLowerCase();
  if(!q) return [];
  return cellObjects.filter(c=>{
    return c.userData.id.toLowerCase().includes(q) || c.userData.name.toLowerCase().includes(q);
  });
}

focusBtn.addEventListener('click', ()=>{
  const q = searchInput.value;
  const matches = findByText(q);
  if(matches.length===0){ alert('Topilmadi. Iltimos ID yoki nomni tekshiring.'); return; }
  const target = matches[0];
  const worldPos = new THREE.Vector3(); target.getWorldPosition(worldPos);
  controls.target.copy(worldPos);
  camera.position.set(worldPos.x + 2.2, worldPos.y + 1.5, worldPos.z + 3.0);
  controls.update();
  // show tooltip at projected screen pos
  const vector = worldPos.clone().project(camera);
  const x = (vector.x + 1)/2 * renderer.domElement.clientWidth;
  const y = -(vector.y - 1)/2 * renderer.domElement.clientHeight;
  tooltip.style.left = (x + 12) + 'px';
  tooltip.style.top = (y + 12) + 'px';
  tooltip.style.display = 'block';
  const d = target.userData;
  tooltip.innerHTML = `<strong>${d.name}</strong><br>ID: ${d.id}<br>Jami: ${d.quantity}`;
});

// resize
window.addEventListener('resize', ()=>{
  camera.aspect = container.clientWidth/container.clientHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(container.clientWidth, container.clientHeight);
});

function animate(){ requestAnimationFrame(animate); renderer.render(scene, camera); }
animate();

/* Instructions:
 - Put this HTML file and the image file '7f1be33a-4cff-4e33-9831-d17036061f51.jpg' in the same folder.
 - Open the HTML file in a browser to view the interactive 3D ombor.
 - To load real data: replace the random userData assignments by reading a JSON/CSV and mapping items to rack/row/col.
*/
</script>
</body>
</html>
